name: Deploy API to Server

on:
  push:
    branches: [ main ]
    paths:
      - 'backends/api/**'
      - '.github/workflows/deploy-api.yml'
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Server (No Build Test)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}
        
    - name: Add server to known hosts
      run: |
        ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts
        
    - name: Deploy to server
      env:
        SERVER_HOST: ${{ secrets.DEPLOY_HOST }}
        SERVER_USER: ${{ secrets.DEPLOY_USER }}
        DATABASE_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
        REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
        REFRESH_SECRET: ${{ secrets.REFRESH_SECRET }}
      run: |
        ssh $SERVER_USER@$SERVER_HOST << 'EOF'
          set -e
          
          echo "ğŸš€ Starting API deployment..."
          echo "ğŸ“ Note: No test build in GitHub Actions to avoid SQL connection errors"
          echo "ğŸ—ï¸  Building will be done on the server with proper database access"
          
          # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ í™•ì¸ ë° ìƒì„±
          echo "ğŸ“ Checking project directory..."
          mkdir -p /home/admin/projects
          
          # Git ì €ì¥ì†Œ í™•ì¸ ë° í´ë¡ /ì—…ë°ì´íŠ¸
          if [ ! -d "/home/admin/projects/mincenter" ]; then
            echo "ğŸ“¥ Cloning repository for the first time..."
            cd /home/admin/projects
            
            # ê¸°ì¡´ ë””ë ‰í† ë¦¬ê°€ ìˆë‹¤ë©´ ê¶Œí•œ ë¬¸ì œ í•´ê²° í›„ ì‚­ì œ
            if [ -d "mincenter" ]; then
              sudo rm -rf mincenter || rm -rf mincenter
            fi
            
            git clone https://github.com/jp9731/mincenter.git
            cd mincenter
            sudo chown -R admin:admin . || true
          else
            echo "ğŸ“ Project directory exists, updating..."
            cd /home/admin/projects/mincenter
            
            # Git ì €ì¥ì†Œì¸ì§€ í™•ì¸
            if [ ! -d ".git" ]; then
              echo "âš ï¸  Not a git repository, re-cloning..."
              cd /home/admin/projects
              sudo rm -rf mincenter || rm -rf mincenter
              git clone https://github.com/jp9731/mincenter.git
              cd mincenter
            else
              echo "ğŸ“¥ Pulling latest code from GitHub..."
              git fetch origin
              git reset --hard origin/main
              
              # Docker ì»¨í…Œì´ë„ˆê°€ ìƒì„±í•œ íŒŒì¼ë“¤ ì •ë¦¬ (ê¶Œí•œ ë¬¸ì œ í•´ê²°)
              echo "ğŸ§¹ Cleaning Docker-generated files..."
              sudo git clean -fd || git clean -fd
              sudo chown -R admin:admin . || true
            fi
          fi
          
          # ê¸°ì¡´ API ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì œê±°
          echo "ğŸ›‘ Stopping existing API container..."
          docker compose stop api 2>/dev/null || true
          docker compose rm -f api 2>/dev/null || true
          
          # Docker ì´ë¯¸ì§€ ì •ë¦¬ (ê¶Œí•œ ë¬¸ì œê°€ ìˆëŠ” ë¹Œë“œ íŒŒì¼ë“¤ ì œê±°)
          echo "ğŸ§¹ Cleaning Docker images and build cache..."
          docker image prune -f 2>/dev/null || true
          docker builder prune -f 2>/dev/null || true
          
          # API ë””ë ‰í† ë¦¬ë¡œ ì´ë™
          cd backends/api
          
          # Dockerfile ìƒì„±
          echo "ğŸ³ Creating Dockerfile..."
          cat > Dockerfile << 'DOCKERFILE_EOF'
        FROM rust:1.75 as builder
        
        WORKDIR /app
        COPY . .
        
        # SQLx CLI ì„¤ì¹˜
        RUN cargo install sqlx-cli --no-default-features --features postgres
        
        # ì˜ì¡´ì„± ìºì‹±ì„ ìœ„í•œ ë”ë¯¸ ë¹Œë“œ
        RUN mkdir -p src && echo "fn main() {}" > src/main.rs
        COPY Cargo.toml Cargo.lock ./
        RUN cargo build --release && rm -rf src
        
        # ì‹¤ì œ ì†ŒìŠ¤ ì½”ë“œ ë³µì‚¬ ë° ë¹Œë“œ
        COPY src ./src
        COPY .sqlx ./.sqlx
        
        # í™˜ê²½ë³€ìˆ˜ ì„¤ì • í›„ ë¹Œë“œ
        ENV SQLX_OFFLINE=true
        RUN cargo build --release --bin mincenter-api
        
        # ëŸ°íƒ€ì„ ì´ë¯¸ì§€
        FROM debian:bookworm-slim
        
        # ëŸ°íƒ€ì„ ì˜ì¡´ì„± ì„¤ì¹˜
        RUN apt-get update && apt-get install -y \
            ca-certificates \
            libssl3 \
            && rm -rf /var/lib/apt/lists/*
        
        WORKDIR /app
        
        # ë¹Œë“œëœ ë°”ì´ë„ˆë¦¬ ë³µì‚¬
        COPY --from=builder /app/target/release/mincenter-api /app/mincenter-api
        
        # ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        RUN chmod +x /app/mincenter-api
        
        # í¬íŠ¸ ë…¸ì¶œ
        EXPOSE 18080
        
        # í™˜ê²½ë³€ìˆ˜ ì„¤ì •
        ENV API_PORT=18080
        ENV RUST_LOG=info
        
        # í—¬ìŠ¤ì²´í¬
        HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
          CMD curl -f http://localhost:18080/api/health || exit 1
        
        # ì‹¤í–‰ ëª…ë ¹
        CMD ["/app/mincenter-api"]
        DOCKERFILE_EOF
          
          # docker-compose.yml ì—…ë°ì´íŠ¸
          echo "ğŸ“ Updating docker-compose.yml..."
          cd /home/admin/projects/mincenter
          
          # API ì„œë¹„ìŠ¤ê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ì—†ìœ¼ë©´ ì¶”ê°€
          if ! grep -q "api:" docker-compose.yml; then
            echo "" >> docker-compose.yml
            echo "  api:" >> docker-compose.yml
            echo "    build:" >> docker-compose.yml
            echo "      context: ./backends/api" >> docker-compose.yml
            echo "      dockerfile: Dockerfile" >> docker-compose.yml
            echo "    container_name: mincenter-api" >> docker-compose.yml
            echo "    ports:" >> docker-compose.yml
            echo '      - "18080:18080"' >> docker-compose.yml
            echo "    environment:" >> docker-compose.yml
            echo "      - DATABASE_URL=postgresql://mincenter:\${DATABASE_PASSWORD}@postgres:5432/mincenter" >> docker-compose.yml
            echo "      - REDIS_URL=redis://:\${REDIS_PASSWORD}@redis:6379" >> docker-compose.yml
            echo "      - API_PORT=18080" >> docker-compose.yml
            echo "      - RUST_LOG=info" >> docker-compose.yml
            echo "      - CORS_ORIGIN=https://mincenter.kr,https://admin.mincenter.kr" >> docker-compose.yml
            echo "      - JWT_SECRET=\${JWT_SECRET}" >> docker-compose.yml
            echo "      - REFRESH_SECRET=\${REFRESH_SECRET}" >> docker-compose.yml
            echo "    depends_on:" >> docker-compose.yml
            echo "      - postgres" >> docker-compose.yml
            echo "      - redis" >> docker-compose.yml
            echo "    networks:" >> docker-compose.yml
            echo "      - mincenter_network" >> docker-compose.yml
            echo "    restart: unless-stopped" >> docker-compose.yml
            echo "    healthcheck:" >> docker-compose.yml
            echo '      test: ["CMD", "curl", "-f", "http://localhost:18080/api/health"]' >> docker-compose.yml
            echo "      interval: 30s" >> docker-compose.yml
            echo "      timeout: 10s" >> docker-compose.yml
            echo "      retries: 3" >> docker-compose.yml
            echo "      start_period: 40s" >> docker-compose.yml
          fi
          
          # í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ì—…ë°ì´íŠ¸
          echo "ğŸ”§ Updating environment variables..."
          sed -i "s/POSTGRES_PASSWORD=.*/POSTGRES_PASSWORD=${DATABASE_PASSWORD}/" .env
          sed -i "s/REDIS_PASSWORD=.*/REDIS_PASSWORD=${REDIS_PASSWORD}/" .env
          
          # JWT ì‹œí¬ë¦¿ì´ ì—†ìœ¼ë©´ ì¶”ê°€
          if ! grep -q "JWT_SECRET" .env; then
            echo "JWT_SECRET=${JWT_SECRET}" >> .env
            echo "REFRESH_SECRET=${REFRESH_SECRET}" >> .env
          fi
          
          # Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ì»¨í…Œì´ë„ˆ ì‹œì‘
          echo "ğŸ—ï¸  Building and starting API container..."
          docker compose build api
          docker compose up -d api
          
          # ì»¨í…Œì´ë„ˆ ì‹œì‘ ëŒ€ê¸°
          echo "â³ Waiting for API container to start..."
          sleep 30
          
          # í—¬ìŠ¤ì²´í¬
          echo "ğŸ¥ Performing health check..."
          for i in {1..10}; do
            if docker exec mincenter-api curl -f http://localhost:18080/api/health; then
              echo "âœ… API server is healthy!"
              break
            else
              echo "â³ Waiting for API server... ($i/10)"
              sleep 10
            fi
          done
          
          # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
          echo "ğŸ“Š Container status:"
          docker compose ps api
          
          echo "ğŸ‰ API deployment completed successfully!"
        EOF
