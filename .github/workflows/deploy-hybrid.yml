name: Deploy Frontend Services

on:
  push:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
  DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
  DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
  DEPLOY_PORT: 22000  # ê¸°ë³¸ SSH í¬íŠ¸ ë˜ëŠ” í•„ìš”ì‹œ secretsë¡œ ì„¤ì •

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Cache Node.js dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.npm
          frontends/site/node_modules
          frontends/admin/node_modules
        key: ${{ runner.os }}-node-${{ hashFiles('frontends/site/package-lock.json', 'frontends/admin/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-
        
    - name: Clean Node.js cache (if needed)
      run: |
        # npm ìºì‹œ ê²€ì¦ ë° ì •ë¦¬
        npm cache verify || npm cache clean --force
        
    - name: Install dependencies (Site)
      working-directory: ./frontends/site
      run: npm ci
      
    - name: Install dependencies (Admin)
      working-directory: ./frontends/admin
      run: npm ci
      
    - name: Build Site Frontend
      working-directory: ./frontends/site
      run: npm run build
      
    - name: Build Admin Frontend
      working-directory: ./frontends/admin
      run: npm run build
      
    # Rust APIëŠ” ì„œë²„ì—ì„œ ì§ì ‘ ë¹Œë“œí•˜ë„ë¡ ë³€ê²½
      
    - name: Debug Secrets
      run: |
        echo "Checking if secrets are set..."
        echo "REMOTE_HOST: ${{ secrets.REMOTE_HOST != '' && 'SET' || 'NOT SET' }}"
        echo "REMOTE_USER: ${{ secrets.REMOTE_USER != '' && 'SET' || 'NOT SET' }}"
        echo "REMOTE_PORT: ${{ secrets.REMOTE_PORT != '' && 'SET' || 'NOT SET' }}"
        echo "SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY != '' && 'SET' || 'NOT SET' }}"
        echo "JWT_SECRET: ${{ secrets.JWT_SECRET != '' && 'SET' || 'NOT SET' }}"
        
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
        
    - name: Add server to known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H -p ${{ env.REMOTE_PORT }} ${{ env.REMOTE_HOST }} >> ~/.ssh/known_hosts || true

    - name: Deploy Frontend Services  
      run: |
        echo "=== Deploying Frontend Services ==="
        
        # ì„œë²„ì— ë””ë ‰í† ë¦¬ ìƒì„± ë° ê¶Œí•œ ì„¤ì •
        ssh -p ${{ env.REMOTE_PORT }} ${{ env.REMOTE_USER }}@${{ env.REMOTE_HOST }} "
          sudo mkdir -p /opt/mincenter/database /opt/mincenter/frontends/site /opt/mincenter/frontends/admin
          sudo chown -R ${{ env.REMOTE_USER }}:${{ env.REMOTE_USER }} /opt/mincenter
          sudo chmod -R 755 /opt/mincenter
        "
        
        # ë°°í¬ìš© docker-compose íŒŒì¼ ì—…ë¡œë“œ (í”„ë¡ íŠ¸ì—”ë“œìš©ìœ¼ë¡œ ìˆ˜ì •)
        scp -P ${{ env.REMOTE_PORT }} docker-compose.deploy.yml ${{ env.REMOTE_USER }}@${{ env.REMOTE_HOST }}:/opt/mincenter/
        scp -P ${{ env.REMOTE_PORT }} database/init.sql ${{ env.REMOTE_USER }}@${{ env.REMOTE_HOST }}:/opt/mincenter/database/
        scp -P ${{ env.REMOTE_PORT }} database/seed.sql ${{ env.REMOTE_USER }}@${{ env.REMOTE_HOST }}:/opt/mincenter/database/
        
        # í”„ë¡ íŠ¸ì—”ë“œ ì†ŒìŠ¤ ì½”ë“œ ì—…ë¡œë“œ
        rsync -avz -e "ssh -p ${{ env.REMOTE_PORT }}" --delete frontends/site/ ${{ env.REMOTE_USER }}@${{ env.REMOTE_HOST }}:/opt/mincenter/frontends/site/
        rsync -avz -e "ssh -p ${{ env.REMOTE_PORT }}" --delete frontends/admin/ ${{ env.REMOTE_USER }}@${{ env.REMOTE_HOST }}:/opt/mincenter/frontends/admin/
        
        # Docker Compose í”„ë¡ íŠ¸ì—”ë“œ ì„œë¹„ìŠ¤ë§Œ ì‹œì‘
        ssh -p ${{ env.REMOTE_PORT }} ${{ env.REMOTE_USER }}@${{ env.REMOTE_HOST }} "cd /opt/mincenter && docker-compose -f docker-compose.deploy.yml up -d --build postgres redis site admin"
        
        echo "Frontend services deployed successfully!"
        
    - name: Verify Frontend Deployment
      run: |
        echo "=== Verifying Frontend Deployment ==="
        
        # ì ì‹œ ëŒ€ê¸°
        sleep 30
        
        # Docker ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
        ssh -p ${{ env.REMOTE_PORT }} ${{ env.REMOTE_USER }}@${{ env.REMOTE_HOST }} "cd /opt/mincenter && docker-compose -f docker-compose.deploy.yml ps"
        
        # ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í™•ì¸
        DB_STATUS=$(ssh -p ${{ env.REMOTE_PORT }} ${{ env.REMOTE_USER }}@${{ env.REMOTE_HOST }} "docker exec mincenter-postgres pg_isready -U postgres" | grep -o "accepting connections" || echo "failed")
        echo "Database Status: $DB_STATUS"
        
        # Redis ì—°ê²° í™•ì¸
        REDIS_STATUS=$(ssh -p ${{ env.REMOTE_PORT }} ${{ env.REMOTE_USER }}@${{ env.REMOTE_HOST }} "docker exec mincenter-redis redis-cli -a default_password ping" | grep -o "PONG" || echo "failed")
        echo "Redis Status: $REDIS_STATUS"
        
        # í”„ë¡ íŠ¸ì—”ë“œ ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
        SITE_STATUS=$(ssh -p ${{ env.REMOTE_PORT }} ${{ env.REMOTE_USER }}@${{ env.REMOTE_HOST }} "curl -s -o /dev/null -w '%{http_code}' http://localhost:3000 || echo '000'")
        ADMIN_STATUS=$(ssh -p ${{ env.REMOTE_PORT }} ${{ env.REMOTE_USER }}@${{ env.REMOTE_HOST }} "curl -s -o /dev/null -w '%{http_code}' http://localhost:3001 || echo '000'")
        
        echo "Site Frontend Status: $SITE_STATUS"
        echo "Admin Frontend Status: $ADMIN_STATUS"
        
        # ê²°ê³¼ ìš”ì•½
        echo "=== Frontend Deployment Summary ==="
        echo "PostgreSQL: $DB_STATUS"
        echo "Redis: $REDIS_STATUS"
        echo "Site Frontend: $SITE_STATUS"
        echo "Admin Frontend: $ADMIN_STATUS"
        
        if [ "$DB_STATUS" = "accepting connections" ] && [ "$REDIS_STATUS" = "PONG" ] && [ "$SITE_STATUS" = "200" ] && [ "$ADMIN_STATUS" = "200" ]; then
          echo "âœ… Frontend services deployment successful!"
          echo "ğŸ’¡ You can now manually deploy the Rust API if needed"
        else
          echo "âŒ Some frontend services may have issues"
          exit 1
        fi 