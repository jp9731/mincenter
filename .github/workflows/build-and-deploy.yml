name: Build and Deploy with Pre-built Images

on:
  # push:
  #   branches: [ main ]  # ë¹„í™œì„±í™”: smart-deploy.ymlê³¼ ì¶©ëŒ ë°©ì§€
  workflow_dispatch:
    inputs:
      reason:
        description: 'Deployment reason'
        required: false
        default: 'Manual deployment'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            frontends/site/package-lock.json
            frontends/admin/package-lock.json
      
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Docker Hub (optional)
        if: github.event_name == 'push'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
        continue-on-error: true
      
      # Site Frontend ë¡œì»¬ ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸
      - name: Install Site Dependencies
        working-directory: ./frontends/site
        run: npm ci
      
      - name: Test Site Build (Development)
        working-directory: ./frontends/site
        run: |
          echo "ğŸ§ª Testing with development environment..."
          npm run build
          echo "âœ… Development build successful"
      
      - name: Test Site Build (Production)
        working-directory: ./frontends/site
        env:
          NODE_ENV: production
        run: |
          echo "ğŸ§ª Testing with production environment..."
          npm run build
          echo "âœ… Production build successful"
      
      # Admin Frontend ë¡œì»¬ ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸
      - name: Install Admin Dependencies
        working-directory: ./frontends/admin
        run: npm ci
      
      - name: Test Admin Build (Production)
        working-directory: ./frontends/admin
        env:
          NODE_ENV: production
        run: |
          echo "ğŸ§ª Testing admin production build..."
          npm run build
          echo "âœ… Admin production build successful"
      
      # Docker ì´ë¯¸ì§€ ë¹Œë“œ (ë¡œì»¬ ë¹Œë“œ ê²€ì¦ í›„)
      - name: Build Site Docker Image
        uses: docker/build-push-action@v5
        with:
          context: ./frontends/site
          file: ./frontends/site/Dockerfile
          push: false
          tags: mincenter-site:latest
          build-args: |
            VITE_API_URL=https://api.mincenter.kr
            PUBLIC_API_URL=https://api.mincenter.kr
            API_URL=https://api.mincenter.kr
            NODE_ENV=production
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Build Admin Docker Image
        uses: docker/build-push-action@v5
        with:
          context: ./frontends/admin
          file: ./frontends/admin/Dockerfile
          push: false
          tags: mincenter-admin:latest
          build-args: |
            VITE_API_URL=https://api.mincenter.kr
            PUBLIC_API_URL=https://api.mincenter.kr
            API_URL=https://api.mincenter.kr
            NODE_ENV=production
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      # ì´ë¯¸ì§€ë¥¼ tar íŒŒì¼ë¡œ ì €ì¥
      - name: Save Docker Images
        run: |
          docker save mincenter-site:latest | gzip > site-image.tar.gz
          docker save mincenter-admin:latest | gzip > admin-image.tar.gz
          ls -la *.tar.gz
      
      # ì„œë²„ ë°°í¬
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}
      
      - name: Deploy to Server
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT || 22000 }}
        run: |
          echo "ğŸš€ Deploying pre-built images to server..."
          
          # SSH known_hosts ì¶”ê°€
          mkdir -p ~/.ssh
          ssh-keyscan -H -p $DEPLOY_PORT $DEPLOY_HOST >> ~/.ssh/known_hosts
          
          # ì´ë¯¸ì§€ íŒŒì¼ì„ ì„œë²„ë¡œ ì „ì†¡
          echo "ğŸ“¦ Uploading Docker images..."
          scp -P $DEPLOY_PORT site-image.tar.gz $DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH/
          scp -P $DEPLOY_PORT admin-image.tar.gz $DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH/
          
          # ì„œë²„ì—ì„œ ì´ë¯¸ì§€ ë¡œë“œ ë° ë°°í¬
          ssh -p $DEPLOY_PORT $DEPLOY_USER@$DEPLOY_HOST "
            cd $DEPLOY_PATH
            
            echo 'ğŸ”„ Loading Docker images...'
            docker load < site-image.tar.gz
            docker load < admin-image.tar.gz
            
            echo 'ğŸ›‘ Stopping existing containers...'
            docker-compose -f docker-compose.prod.yml stop site admin || true
            
            echo 'ğŸš€ Starting new containers...'
            docker-compose -f docker-compose.prod.yml up -d site admin
            
            echo 'ğŸ§¹ Cleaning up image files...'
            rm -f site-image.tar.gz admin-image.tar.gz
            
            echo 'âœ… Deployment completed!'
          "
      
      # ë°°í¬ ê²€ì¦
      - name: Verify Deployment
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT || 22000 }}
        run: |
          echo "ğŸ” Verifying deployment..."
          
          sleep 30  # ì„œë¹„ìŠ¤ ì‹œì‘ ëŒ€ê¸°
          
          ssh -p $DEPLOY_PORT $DEPLOY_USER@$DEPLOY_HOST "
            # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
            docker ps --filter 'name=mincenter' --format 'table {{.Names}}\t{{.Status}}\t{{.Ports}}'
            
            # ì„œë¹„ìŠ¤ ì‘ë‹µ í™•ì¸
            SITE_STATUS=\$(curl -s -o /dev/null -w '%{http_code}' http://localhost:13000 || echo '000')
            ADMIN_STATUS=\$(curl -s -o /dev/null -w '%{http_code}' http://localhost:13001 || echo '000')
            
            echo 'Site Status: \$SITE_STATUS'
            echo 'Admin Status: \$ADMIN_STATUS'
            
            if [ \"\$SITE_STATUS\" = \"200\" ] && [ \"\$ADMIN_STATUS\" = \"200\" ]; then
              echo 'âœ… All services are running successfully!'
            else
              echo 'âŒ Some services may have issues'
              exit 1
            fi
          "