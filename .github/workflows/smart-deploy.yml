name: Smart Deploy

on:
  # push:
  #   branches: [ main ]  # ë¹„í™œì„±í™”: build-and-deploy.yml ì‚¬ìš©
  workflow_dispatch:
    inputs:
      reason:
        description: 'Deployment reason'
        required: false
        default: 'Manual deployment'

jobs:
  smart-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup SSH for Deployment
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}
      
      - name: Check Required Secrets
        run: |
          echo "ğŸ” Checking required secrets..."
          
          # í•„ìˆ˜ Secrets í™•ì¸
          if [ -z "${{ secrets.DEPLOY_HOST }}" ]; then
            echo "âŒ DEPLOY_HOST secret is missing"
            exit 1
          fi
          
          if [ -z "${{ secrets.DEPLOY_USER }}" ]; then
            echo "âŒ DEPLOY_USER secret is missing"
            exit 1
          fi
          
          if [ -z "${{ secrets.DEPLOY_PATH }}" ]; then
            echo "âŒ DEPLOY_PATH secret is missing"
            exit 1
          fi
          
          echo "âœ… All required secrets are present"
      
      - name: Smart Deploy on Server
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT || 22000 }}
        run: |
          echo "ğŸš€ Starting Smart Deploy..."
          echo "Trigger: ${{ github.event_name }}"
          echo "Reason: ${{ github.event.inputs.reason || 'Auto-deployment due to code changes' }}"
          
          # SSH known_hosts ì¶”ê°€
          mkdir -p ~/.ssh
          ssh-keyscan -H -p $DEPLOY_PORT $DEPLOY_HOST >> ~/.ssh/known_hosts
          
          echo "ğŸ”— Testing SSH connection..."
          # SSH ì—°ê²° í…ŒìŠ¤íŠ¸
          ssh -p $DEPLOY_PORT $DEPLOY_USER@$DEPLOY_HOST "echo 'SSH connection successful'" || {
            echo "âŒ SSH connection failed"
            exit 1
          }
          
          echo "ğŸ“ Checking server directory..."
          # ì„œë²„ ë””ë ‰í† ë¦¬ í™•ì¸
          ssh -p $DEPLOY_PORT $DEPLOY_USER@$DEPLOY_HOST "
            echo 'Current directory: \$(pwd)'
            echo 'Target directory: $DEPLOY_PATH'
            ls -la $DEPLOY_PATH || echo 'Directory does not exist'
          "
          
          # Docker ì •ë¦¬ ë‹¨ê³„
          echo "ğŸ” Running Docker cleanup..."
          ssh -o ConnectTimeout=30 -o ServerAliveInterval=60 -o ServerAliveCountMax=3 -p $DEPLOY_PORT $DEPLOY_USER@$DEPLOY_HOST "
            cd $DEPLOY_PATH
            
            # Docker ì •ë¦¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
            if [ -f scripts/quick-docker-cleanup.sh ]; then
              chmod +x scripts/quick-docker-cleanup.sh
              ./scripts/quick-docker-cleanup.sh
            else
              docker system prune -a -f --volumes || true
              docker builder prune -a -f || true
            fi
          " || {
            echo "âš ï¸ Docker cleanup failed, but continuing..."
          }
          
          # ë°°í¬ ë‹¨ê³„
          echo "ğŸš€ Starting deployment..."
          ssh -o ConnectTimeout=30 -o ServerAliveInterval=60 -o ServerAliveCountMax=3 -p $DEPLOY_PORT $DEPLOY_USER@$DEPLOY_HOST "
            cd $DEPLOY_PATH
            
            echo 'Current working directory: \$(pwd)'
            
            # .env íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸
            if [ ! -f .env ]; then
              echo 'âŒ .env file not found on server'
              exit 1
            fi
            
            echo 'âœ… Using existing .env file on server'
            
            # ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ í™•ì¸
            if [ ! -f scripts/smart-deploy-server.sh ]; then
              echo 'âŒ smart-deploy-server.sh not found'
              exit 1
            fi
            
            echo 'âœ… Found smart-deploy-server.sh'
            
            # ìŠ¤ë§ˆíŠ¸ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
            chmod +x scripts/smart-deploy-server.sh
            ./scripts/smart-deploy-server.sh
          " || {
            echo "âŒ Smart Deploy failed"
            exit 1
          }
          
          echo "âœ… Smart Deploy completed!"