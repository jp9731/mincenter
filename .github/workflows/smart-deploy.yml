name: Smart Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      reason:
        description: 'Deployment reason'
        required: false
        default: 'Manual deployment'

jobs:
  smart-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup SSH for Deployment
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}
      
      - name: Check Required Secrets
        run: |
          echo "ğŸ” Checking required secrets..."
          
          # í•„ìˆ˜ Secrets í™•ì¸
          if [ -z "${{ secrets.DEPLOY_HOST }}" ]; then
            echo "âŒ DEPLOY_HOST secret is missing"
            exit 1
          fi
          
          if [ -z "${{ secrets.DEPLOY_USER }}" ]; then
            echo "âŒ DEPLOY_USER secret is missing"
            exit 1
          fi
          
          if [ -z "${{ secrets.DEPLOY_PATH }}" ]; then
            echo "âŒ DEPLOY_PATH secret is missing"
            exit 1
          fi
          
          echo "âœ… All required secrets are present"
      
      - name: Deploy .env file to server
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT || 22 }}
        run: |
          echo "ğŸ“ Deploying .env file to server..."
          
          # SSH known_hosts ì¶”ê°€
          mkdir -p ~/.ssh
          ssh-keyscan -H -p $DEPLOY_PORT $DEPLOY_HOST >> ~/.ssh/known_hosts
          
          # .env íŒŒì¼ì„ ì„œë²„ë¡œ ë³µì‚¬
          scp -P $DEPLOY_PORT .env $DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH/.env
          
          echo "âœ… .env file deployed successfully"
      
      - name: Smart Deploy on Server
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT || 22 }}
        run: |
          echo "ğŸš€ Starting Smart Deploy..."
          echo "Trigger: ${{ github.event_name }}"
          echo "Reason: ${{ github.event.inputs.reason || 'Auto-deployment due to code changes' }}"
          
          # SSH known_hosts ì¶”ê°€
          mkdir -p ~/.ssh
          ssh-keyscan -H -p $DEPLOY_PORT $DEPLOY_HOST >> ~/.ssh/known_hosts
          
          # ì„œë²„ì— ìŠ¤ë§ˆíŠ¸ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (.env íŒŒì¼ ì‚¬ìš©)
          ssh -p $DEPLOY_PORT $DEPLOY_USER@$DEPLOY_HOST "
            cd $DEPLOY_PATH
            
            # .env íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸
            if [ ! -f .env ]; then
              echo 'âŒ .env file not found on server'
              exit 1
            fi
            
            # .env íŒŒì¼ì„ í™˜ê²½ë³€ìˆ˜ë¡œ ë¡œë“œ
            set -a
            source .env
            set +a
            
            echo 'âœ… Environment variables loaded from .env file'
            
            # ìŠ¤ë§ˆíŠ¸ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
            chmod +x scripts/smart-deploy-server.sh
            ./scripts/smart-deploy-server.sh
          " || {
            echo "âŒ Smart Deploy failed"
            exit 1
          }
          
          echo "âœ… Smart Deploy completed!"